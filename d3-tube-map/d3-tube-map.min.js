!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],n):n(t.tubeMap={},t.d3)}(this,function(t,n){"use strict";var e=function(t){this.stations=t};e.prototype.toArray=function(){var t=[];for(var n in this.stations)if(this.stations.hasOwnProperty(n)){var e=this.stations[n];e.name=n,t.push(e)}return t},e.prototype.interchanges=function(){return this.toArray().filter(function(t){return"interchange"===t.marker[0].marker})},e.prototype.normalStations=function(){var t=[];return this.toArray().filter(function(t){return"interchange"!==t.marker[0].marker}).forEach(function(n){n.marker.forEach(function(e){t.push({name:n.name,line:e.line,x:n.x,y:n.y,color:e.color,shiftX:e.shiftX,shiftY:e.shiftY,labelPos:n.labelPos})})}),t},e.prototype.visited=function(){return this.toArray().filter(function(t){return t.visited})},e.prototype.visitedFriendly=function(){return this.visited().map(function(t){return t.title})},e.prototype.isVisited=function(t){return this.stations[t].visited};var r=function(t){this.lines=t};r.prototype.highlightLine=function(t){this.lines.forEach(function(n){n.name===t&&(n.highlighted=!0)})},r.prototype.unhighlightLine=function(t){this.lines.forEach(function(n){n.name===t&&(n.highlighted=!1)})},t.tubeMap=function(){function t(t){t.each(function(t){t=i(t),p=t;var e,r,s=n.min(t.raw,function(t){return n.min(t.nodes,function(t){return t.coords[0]})}),l=n.max(t.raw,function(t){return n.max(t.nodes,function(t){return t.coords[0]})}),c=n.min(t.raw,function(t){return n.min(t.nodes,function(t){return t.coords[1]})}),y=n.max(t.raw,function(t){return n.max(t.nodes,function(t){return t.coords[1]})}),S=(l-s)/(y-c),O=(v-b.left-b.right)/(k-b.top-b.bottom),L=O/S;S>O?(e=v-b.left-b.right,r=(k-b.top-b.bottom)*L):(e=(v-b.left-b.right)/L,r=k-b.top-b.bottom),w.domain([s,l]).range([0,e]),A.domain([c,y]).range([r,0]),x.domain([n.min(t.stations.toArray(),function(t){if(void 0!==t.position)return t.position.lon}),n.max(t.stations.toArray(),function(t){if(void 0!==t.position)return t.position.lon})]).range([0,e]),C.domain([n.min(t.stations.toArray(),function(t){if(void 0!==t.position)return t.position.lat}),n.max(t.stations.toArray(),function(t){if(void 0!==t.position)return t.position.lat})]).range([r,0]),h=P*(w(1)-w(0));var E=(f=n.select(this).selectAll("svg").data([t])).enter().append("svg").append("g");E.append("rect").attr("width","100%").attr("height","100%").attr("fill","white"),g=n.zoom().scaleExtent([.5,6]).on("zoom",function(){m.attr("transform",n.event.transform.toString())});var X=(m=E.call(g).append("g")).append("g").attr("class","river").selectAll("path").data(function(t){return[t.river]}),Y=m.append("g").attr("class","lines").selectAll("path").data(function(t){return t.lines.lines}),q=m.append("g").attr("class","interchanges").selectAll("path").data(function(t){return t.stations.interchanges()}),N=m.append("g").attr("class","stations").selectAll("path").data(function(t){return t.stations.normalStations()}),R=m.append("g").attr("class","labels").selectAll("text").data(function(t){return t.stations.toArray()}),j=m.append("g").attr("class","geoStations").style("display","none").selectAll("path").data(function(t){return t.stations.toArray()}),z=m.append("g").attr("class","discrepencies").style("display","none").selectAll("path").data(function(t){return t.stations.toArray()});f.attr("width","100%").attr("height","100%"),X.enter().append("path").attr("d",o).attr("stroke","#C4E8F8").attr("fill","none").attr("stroke-width",1.8*h),Y.enter().append("path").attr("d",o).attr("id",function(t){return t.name}).attr("stroke",function(t){return t.color}).attr("fill","none").attr("stroke-width",function(t){return t.highlighted?1.3*h:h}).classed("line",!0);var F=n.arc().innerRadius(0).outerRadius(h).startAngle(0).endAngle(2*Math.PI);q.enter().append("g").attr("id",function(t){return t.name}).on("click",function(){var t=n.select(this).attr("id");a(t),M.call("click",this,t)}).append("path").attr("d",F).attr("transform",function(t){return"translate("+w(t.x+t.marker[0].shiftX*P)+","+A(t.y+t.marker[0].shiftY*P)+")"}).attr("stroke-width",h/2).attr("fill",function(t){return t.visited?"#000000":"#ffffff"}).attr("stroke",function(t){return t.visited?"#ffffff":"#000000"}).classed("interchange",!0).style("cursor","pointer");var Q=n.line().x(function(t){return w(t[0])}).y(function(t){return A(t[1])});N.enter().append("g").attr("id",function(t){return t.name}).on("click",function(){var t=n.select(this).attr("id");a(t),M.call("click",this,t)}).append("path").attr("d",function(t){var n,e=Math.sqrt(2);switch(t.labelPos.toLowerCase()){case"n":n=[0,1];break;case"ne":n=[1/e,1/e];break;case"e":n=[1,0];break;case"se":n=[1/e,-1/e];break;case"s":n=[0,-1];break;case"sw":n=[-1/e,-1/e];break;case"w":n=[-1,0];break;case"nw":n=[-1/e,1/e]}return Q([[t.x+t.shiftX*P+P/2.05*n[0],t.y+t.shiftY*P+P/2.05*n[1]],[t.x+t.shiftX*P+P*n[0],t.y+t.shiftY*P+P*n[1]]])}).attr("stroke",function(t){return t.color}).attr("stroke-width",h/2).attr("fill","none").attr("class",function(t){return t.line}).attr("id",function(t){return t.name}).classed("station",!0),R.enter().append("g").attr("id",function(t){return t.name}).classed("label",!0).on("click",function(){var t=n.select(this).attr("id");a(t),M.call("click",this,t)}).append("text").text(function(t){return t.label}).attr("dy",.1).attr("x",function(t){return w(t.x+t.labelShiftX)+d(t).pos[0]}).attr("y",function(t){return A(t.y+t.labelShiftY)-d(t).pos[1]}).attr("text-anchor",function(t){return d(t).textAnchor}).style("display",function(t){return!0!==t.hide?"block":"none"}).style("font-size",1.2*h/P+"px").style("-webkit-user-select","none").attr("class",function(t){return t.marker.map(function(t){return t.line}).join(" ")}).classed("highlighted",function(t){return t.visited}).call(u);var I=n.arc().innerRadius(0).outerRadius(h/4).startAngle(0).endAngle(2*Math.PI);j.enter().append("path").attr("d",I).attr("transform",function(t){return"translate("+x(void 0!==t.position?t.position.lon:NaN)+","+C(void 0!==t.position?t.position.lat:NaN)+")"}).attr("id",function(t){return t.name}).attr("fill","#888888"),z.enter().append("path").attr("d",function(t){return n.line()([[w(t.x),A(t.y)],[x(t.position.lon),C(t.position.lat)]])}).attr("id",function(t){return t.name}).attr("stroke","#AAAAAA").attr("stroke-width",h/4).style("stroke-dasharray","3, 3")})}function a(t){n.select(".labels").selectAll(".label").classed("selected",!1),n.select(".labels").select("#"+t).classed("selected",!0)}function s(t,e){n.select(".labels").select("#"+t).select("text").classed("highlighted",e)}function o(t){for(var n,e,r,a,s,o="",i=t.nodes,l=w(1)-w(0),c=[t.shiftCoords[0]*h/l,t.shiftCoords[1]*h/l],d="diagonal",u=0;u<i.length;u++)if(u>0){n=i[u],e=i[u-1],r=Math.round(e.coords[0]-n.coords[0]),a=Math.round(e.coords[1]-n.coords[1]);var f=[0,0];if(u===i.length-1&&(0==r||0==a?(r>0&&(f=[-h/(4*l),0]),r<0&&(f=[h/(4*l),0]),a>0&&(f=[0,-h/(4*l)]),a<0&&(f=[0,h/(4*l)])):(g=Math.sqrt(2),r>0&&a>0&&(f=[-h/(4*l*g),-h/(4*l*g)]),r>0&&a<0&&(f=[-h/(4*l*g),h/(4*l*g)]),r<0&&a>0&&(f=[h/(4*l*g),-h/(4*l*g)]),r<0&&a<0&&(f=[h/(4*l*g),h/(4*l*g)]))),s=[[w(e.coords[0]+c[0]),A(e.coords[1]+c[1])],[w(n.coords[0]+c[0]+f[0]),A(n.coords[1]+c[1]+f[1])]],0==r||0==a)d="udlr",o+="L"+s[1][0]+","+s[1][1];else if(Math.abs(r)==Math.abs(a)&&Math.abs(r)>1)d="diagonal",o+="L"+s[1][0]+","+s[1][1];else if(1==Math.abs(r)&&1==Math.abs(a))switch(n.dir.toLowerCase()){case"e":o+="Q"+s[1][0]+","+s[0][1]+","+s[1][0]+","+s[1][1];break;case"s":case"n":o+="Q"+s[0][0]+","+s[1][1]+","+s[1][0]+","+s[1][1];break;case"w":o+="Q"+s[1][0]+","+s[0][1]+","+s[1][0]+","+s[1][1]}else if(1==Math.abs(r)&&2==Math.abs(a)||2==Math.abs(r)&&1==Math.abs(a)){var p;1==r?"udlr"==d?p=[s[0][0],s[0][1]+(s[1][1]-s[0][1])/2]:"diagonal"==d&&(p=[s[1][0],s[0][1]+(s[1][1]-s[0][1])/2]):-1==r?"udlr"==d?p=[s[0][0],s[0][1]+(s[1][1]-s[0][1])/2]:"diagonal"==d&&(p=[s[1][0],s[0][1]+(s[1][1]-s[0][1])/2]):-2==r?"udlr"==d?p=[s[0][0]+(s[1][0]-s[0][0])/2,s[0][1]]:"diagonal"==d&&(p=[s[0][0]+(s[1][0]-s[0][0])/2,s[1][1]]):2==r&&("udlr"==d?p=[s[0][0]+(s[1][0]-s[0][0])/2,s[0][1]]:"diagonal"==d&&(p=[s[0][0]+(s[1][0]-s[0][0])/2,s[1][1]])),o+="C"+p[0]+","+p[1]+","+p[0]+","+p[1]+","+s[1][0]+","+s[1][1]}}else{n=i[u+1],e=i[u],r=Math.round(e.coords[0]-n.coords[0]),a=Math.round(e.coords[1]-n.coords[1]);var m=[0,0];if(0==r||0==a)r>0&&(m=[h/(4*l),0]),r<0&&(m=[-h/(4*l),0]),a>0&&(m=[0,h/(4*l)]),a<0&&(m=[0,-h/(4*l)]);else{var g=Math.sqrt(2);r>0&&a>0&&(m=[h/(4*l*g),h/(4*l*g)]),r>0&&a<0&&(m=[h/(4*l*g),-h/(4*l*g)]),r<0&&a>0&&(m=[-h/(4*l*g),h/(4*l*g)]),r<0&&a<0&&(m=[-h/(4*l*g),-h/(4*l*g)])}o+="M"+(s=[w(e.coords[0]+c[0]+m[0]),A(e.coords[1]+c[1]+m[1])])[0]+","+s[1]}return o}function i(t){var n={};return n.raw=t.lines,n.river=t.river,n.stations=l(t),n.lines=c(t.lines),n}function l(t){return t.lines.forEach(function(n){for(var e=0;e<n.nodes.length;e++){var r=n.nodes[e];if(r.hasOwnProperty("name")){if(!t.stations.hasOwnProperty(r.name))throw new Error("Cannot find station with key: "+r.name);var a=t.stations[r.name];a.x=r.coords[0],a.y=r.coords[1],void 0===a.labelPos&&(a.labelPos=r.labelPos,a.labelShiftX=r.hasOwnProperty("shiftCoords")?r.shiftCoords[0]:n.shiftCoords[0],a.labelShiftY=r.hasOwnProperty("shiftCoords")?r.shiftCoords[1]:n.shiftCoords[1]),r.hasOwnProperty("canonical")&&(a.labelShiftX=r.hasOwnProperty("shiftCoords")?r.shiftCoords[0]:n.shiftCoords[0],a.labelShiftY=r.hasOwnProperty("shiftCoords")?r.shiftCoords[1]:n.shiftCoords[1],a.labelPos=r.labelPos),a.label=t.stations[r.name].title,a.position=t.stations[r.name].position,a.visited=!1,r.hide||(a.marker=a.marker||[],a.marker.push({line:n.name,color:n.color,labelPos:r.labelPos,marker:r.hasOwnProperty("marker")?r.marker:"station",shiftX:r.hasOwnProperty("shiftCoords")?r.shiftCoords[0]:n.shiftCoords[0],shiftY:r.hasOwnProperty("shiftCoords")?r.shiftCoords[1]:n.shiftCoords[1]}))}}}),new e(t.stations)}function c(t){var n=[];return t.forEach(function(t){var e={name:t.name,title:t.label,stations:[],color:t.color,shiftCoords:t.shiftCoords,nodes:t.nodes,highlighted:!1};n.push(e);for(var r=0;r<t.nodes.length;r++){var a=t.nodes[r];a.hasOwnProperty("name")&&e.stations.push(a.name)}}),new r(n)}function d(t){var n,e,r=1.8*h,a=t.label.split(/\n/).length,s=Math.sqrt(2);switch(t.labelPos.toLowerCase()){case"n":n=[0,h*(a-1)+r],e="middle";break;case"ne":n=[r/s,(h*(a-1)+r)/s],e="start";break;case"e":n=[r,0],e="start";break;case"se":n=[r/s,-r/s],e="start";break;case"s":n=[0,-P*r],e="middle";break;case"sw":n=[-r/s,-1.4*r/s],e="end";break;case"w":n=[-r,0],e="end";break;case"nw":n=[-(h*(a-1)+r)/s,(h*(a-1)+r)/s],e="end"}return{pos:n,textAnchor:e}}function u(t){t.each(function(){for(var t=n.select(this),e=t.text().split(/\n/),r=t.attr("y"),a=t.attr("x"),s=parseFloat(t.attr("dy")),o=(t.text(null).append("tspan").attr("x",a).attr("y",r).attr("dy",s+"em").text(e[0]),1);o<e.length;o++)t.append("tspan").attr("x",a).attr("y",r).attr("dy",1.1*o+s+"em").text(e[o])})}var h,f,p,m,g,y,b={top:80,right:80,bottom:20,left:80},v=760,k=640,w=n.scaleLinear(),A=n.scaleLinear(),x=n.scaleLinear(),C=n.scaleLinear(),P=1.2,M=n.dispatch("click");return t.width=function(n){return arguments.length?(v=n,t):v},t.height=function(n){return arguments.length?(k=n,t):k},t.margin=function(n){return arguments.length?(b=n,t):b},t.highlightLine=function(t){var e=n.select("#map").selectAll(".line"),r=n.select("#map").selectAll(".station"),a=n.select("#map").selectAll(".label");e.classed("translucent",!0),r.classed("translucent",!0),a.classed("translucent",!0),r.filter("."+t).classed("translucent",!1),a.filter("."+t).classed("translucent",!1),n.select("#"+t).classed("translucent",!1)},t.unhighlightAll=function(){var t=n.select("#map").selectAll(".line"),e=n.select("#map").selectAll(".station"),r=n.select("#map").selectAll(".label");t.classed("translucent",!1),e.classed("translucent",!1),r.classed("translucent",!1)},t.unhighlightLine=function(){this.unhighlightAll()},t.highlightNearestStation=function(t){p.stations.stations[t]},t.centerOnPub=function(t){if(void 0!==t){var n=p.stations.stations[t],e=window.innerWidth,r=window.innerHeight;y=[-2*w(n.x)+e/2,-2*A(n.y)+r/2],g.translateBy(y).scaleTo(2),m.transition().duration(750).attr("transform","translate("+y[0]+","+y[1]+")scale(2)")}},t.addStation=function(t){s(t,!0)},t.removeStation=function(t){s(t,!1)},t.visitStations=function(t){n.selectAll(".labels").select("text").classed("highlighted",!1),t.map(function(t){s(t,!0)})},t.on=function(t,n){M.on(t,n)},t.selectStation=function(t){a(t)},t},Object.defineProperty(t,"__esModule",{value:!0})});